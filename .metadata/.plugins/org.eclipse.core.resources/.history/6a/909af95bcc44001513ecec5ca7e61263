/*
 * DensityValues.h
 *
 *  Created on: Jul 14, 2014 at Precision & Microsystems Engineering group, TU Delft
 *      Author: Deepak K. Gupta
 */

#ifndef DENSITYVALUES_H_
#define DENSITYVALUES_H_

#include <deal.II/base/point.h>
#include <vector>
#include <deal.II/numerics/vector_tools.h>
#include <deal.II/numerics/matrix_tools.h>
#include <atop/TopologyOptimization/design_analysis.h>
#include <atop/TopologyOptimization/neighbors.h>
#include <atop/TopologyOptimization/cell_prop.h>
#include <atop/physics/elasticity.h>
#include <deal.II/dofs/dof_handler.h>
#include <atop/TopologyOptimization/projection.h>

using namespace dealii;
namespace topopt{
	class DensityValues{
	public:
		double xmin, xmax, ymin, ymax;
		unsigned int x_count, y_count;
		double x_spacing, y_spacing;
		std::vector<double> rho_mesh;
		unsigned int itr_count;
		double max_projection_radius, min_projection_radius;
		double max_cell_area;
		double gamma;
		Point<2> design_point;
		unsigned int cycle;
		std::vector<std::vector<double> > density2d;
		void update_density_mesh(
				std::vector<CellProperties> &cellprop,
				std::vector<double> &density_mesh);
		void get_vol_fraction(
				std::vector<CellProperties> &cellprop,
				std::vector<double> &density_mesh,
				double &density_sum,
				double &max_cell_area,
				StoreElasticData &elastic_data);
		void create_neighbours(
				std::vector<CellProperties> &cellprop,
				FESystem<2> &fe,
				DoFHandler<2> &dof_handler,
				double rmin
				);

		void neighbor_search(DoFHandler<2>::active_cell_iterator cell1,
				DoFHandler<2>::active_cell_iterator cell,
				std::vector<DoFHandler<2>::active_cell_iterator> &neighbor_iterators,
				double rmin
				);

		void calculate_weights(std::vector<CellProperties>  &cellprop,
				unsigned int cell_itr1,
				double rmin);

		void filter(std::vector<CellProperties> &cellprop);

		double get_dxPhys_dx(CellProperties &cellp,
				unsigned int q_point2,
				unsigned int cell_itr2,
				unsigned int q_point);
	};
}

namespace atop{
	template <int dim>
	class DensityField{
	public:
		double max_cell_area;
		void create_neighbors(
				std::vector<CellInfo> &cell_info_vector,
				FESystem<dim> &fe,
				FESystem<dim> &density_fe,
				DoFHandler<dim> &dof_handler,
				DoFHandler<dim> &density_dof_handler,
				Projection &projection
				);

		/**
		 * Function for applying projection/filter operation on density values
		 */
		void smoothing(
				std::vector<CellInfo> &cell_info_vector,
				std::vector<CellInfo> &density_cell_info_vector
				);

		void update_design_vector(
				std::vector<CellInfo> &density_cell_info_vector,
				std::vector<double> &design_vector);

		double get_dxPhys_dx(CellInfo &cell_info,
				unsigned int q_point,
				unsigned int density_cell_itr2);
	private:

		/**
		 * This function needs to be overloaded since there are at the moment
		 * some unknown issues in creating the template for this function.
		 * Currently, the implementation is only for dim = 2.
		 */
		void neighbor_search(
				DoFHandler<2>::active_cell_iterator cell1,
				DoFHandler<2>::active_cell_iterator cell,
				std::vector<DoFHandler<2>::active_cell_iterator> &neighbor_iterators,
				double rmin
				);

		void calculate_weights(
				std::vector<CellInfo>  &cell_info_vector,
				unsigned int cell_itr1,
				double rmin);


	};

	template class DensityField<2>;
}


#endif /* DENSITYVALUES_H_ */
